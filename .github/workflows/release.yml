name: Build Installer on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # [æ–°å¢ž] å‡†å¤‡åº”ç”¨å›¾æ ‡
      - name: Prepare Application Icon
        shell: bash
        run: |
          # ä¸‹è½½ "Label" (æ ‡ç­¾) emoji ä½œä¸ºå›¾æ ‡ï¼Œå¯“æ„é‡å‘½å/æ‰“æ ‡
          # Google Noto Emoji: u1f3f7 (ðŸ·ï¸)
          curl -L "https://raw.githubusercontent.com/googlefonts/noto-emoji/main/png/128/emoji_u1f3f7.png" -o "app_icon.png"
          # ä½¿ç”¨ ImageMagick è½¬æ¢ä¸ºå¤šå°ºå¯¸ ico
          magick app_icon.png -define icon:auto-resize=64,48,32,16 app_icon.ico

      # [ä¿®å¤] Bash ç‰ˆæœ¬å·ç”Ÿæˆ
      - name: Generate Version Number
        id: versioning
        shell: bash
        run: |
          # æå– version è¡Œ
          VERSION_LINE=$(grep '^version\s*=' Cargo.toml | head -n 1)
          # æå–ä¸»ç‰ˆæœ¬å·
          BASE_VERSION=$(echo "$VERSION_LINE" | sed -E 's/version\s*=\s*"([0-9]+\.[0-9]+).*/\1/')
          
          if [ -z "$BASE_VERSION" ]; then BASE_VERSION="1.0"; fi
          
          NEW_VERSION="${BASE_VERSION}.${{ github.run_number }}"
          echo "::notice::Target Build Version: $NEW_VERSION"
          
          echo "BUILD_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 2. ä¿®æ”¹ Cargo.toml ç‰ˆæœ¬
      # ----------------------------------------------------------------
      - name: Update Cargo Version
        shell: bash
        run: |
          sed -i "s/^version = \".*\"/version = \"$BUILD_VERSION\"/" Cargo.toml

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: windows-release-build

      - name: Quick Check
        run: cargo check --release

      - name: Build Binary (Release)
        run: cargo build --release

      - name: Install Inno Setup
        run: choco install innosetup --no-progress

      # ----------------------------------------------------------------
      # 3. ç¼–è¯‘å®‰è£…åŒ… (ISCC)
      # ----------------------------------------------------------------
      - name: Compile Installer (.exe)
        shell: cmd
        run: |
          set "OUTPUT_NAME=HashRenamer_Setup_v%BUILD_VERSION%"
          
          if not exist Output mkdir Output
          
          iscc "/DMyAppVersion=%BUILD_VERSION%" "/OOutput" "/F%OUTPUT_NAME%" installer.iss
          
          echo INSTALLER_NAME=%OUTPUT_NAME%>> %GITHUB_ENV%

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: HashRenamer_Installer_v${{ env.BUILD_VERSION }}
          path: Output/${{ env.INSTALLER_NAME }}.exe