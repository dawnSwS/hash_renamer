name: Build Installer on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Version Number
        id: versioning
        shell: powershell
        run: |
          # 读取 Cargo.toml 内容
          $cargoContent = Get-Content Cargo.toml -Raw
          
          # 正则提取主版本号 (Major.Minor)
          if ($cargoContent -match 'version\s*=\s*"(?<ver>\d+\.\d+)\.\d+"') {
              $baseVersion = $Matches.ver
          } else {
              $baseVersion = "1.0"
          }
          
          # 组合新版本号
          $newVersion = "$baseVersion.${{ github.run_number }}"
          Write-Host "::notice::Target Build Version: $newVersion"
          
          # 将版本号保存到环境变量
          echo "BUILD_VERSION=$newVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # ----------------------------------------------------------------
      # 2. 修改 Cargo.toml 版本
      # 目的：让编译出的 .exe 文件属性中包含正确的版本信息
      # ----------------------------------------------------------------
      - name: Update Cargo Version
        shell: powershell
        run: |
          $ver = $env:BUILD_VERSION
          (Get-Content Cargo.toml) -replace '^version = ".*"', "version = `"$ver`"" | Set-Content Cargo.toml

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: windows-release-build

      - name: Build Binary (Release)
        # --release 会自动应用我们在 Cargo.toml 里的体积优化配置
        run: cargo build --release --verbose

      - name: Install Inno Setup
        run: choco install innosetup --no-progress

      # ----------------------------------------------------------------
      # 3. 编译安装包 (ISCC)
      # 优化：使用命令行参数 /D 和 /F 动态传入版本号和文件名
      # ----------------------------------------------------------------
      - name: Compile Installer (.exe)
        shell: powershell
        run: |
          # 定义输出文件名，带上版本号 (如 HashRenamer_Setup_v1.0.55)
          $outputName = "HashRenamer_Setup_v${{ env.BUILD_VERSION }}"
          
          # 确保 Output 目录存在
          if (-not (Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" }
          
          # 编译命令：
          # /DMyAppVersion="..." -> 覆盖 .iss 中的版本号
          # /O"Output"         -> 强制指定输出目录
          # /F"..."            -> 强制指定输出文件名
          iscc /DMyAppVersion="${{ env.BUILD_VERSION }}" /O"Output" /F"$outputName" installer.iss
          
          # 记录文件名供上传步骤使用
          echo "INSTALLER_NAME=$outputName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          # Artifact 名称也带上版本号，方便下载区分
          name: HashRenamer_Installer_v${{ env.BUILD_VERSION }}
          # 上传 Output 目录下的对应文件
          path: Output/${{ env.INSTALLER_NAME }}.exe
          retention-days: 90