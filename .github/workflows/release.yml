name: Build Installer on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # [修复] Bash 版本号生成
      - name: Generate Version Number
        id: versioning
        shell: bash
        run: |
          # 提取 version 行
          VERSION_LINE=$(grep '^version\s*=' Cargo.toml | head -n 1)
          # 提取主版本号
          BASE_VERSION=$(echo "$VERSION_LINE" | sed -E 's/version\s*=\s*"([0-9]+\.[0-9]+).*/\1/')
          
          if [ -z "$BASE_VERSION" ]; then BASE_VERSION="1.0"; fi
          
          NEW_VERSION="${BASE_VERSION}.${{ github.run_number }}"
          echo "::notice::Target Build Version: $NEW_VERSION"
          
          echo "BUILD_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 2. 修改 Cargo.toml 版本
      # [修复] Bash + sed，无 BOM 烦恼
      # ----------------------------------------------------------------
      - name: Update Cargo Version
        shell: bash
        run: |
          sed -i "s/^version = \".*\"/version = \"$BUILD_VERSION\"/" Cargo.toml

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          key: windows-release-build

      - name: Quick Check
        run: cargo check --release

      - name: Build Binary (Release)
        run: cargo build --release

      - name: Install Inno Setup
        run: choco install innosetup --no-progress

      # ----------------------------------------------------------------
      # 3. 编译安装包 (ISCC)
      # [修复] 切换为 CMD，原生支持 Windows 参数 (/D, /O)，无需双斜杠 hack
      # ----------------------------------------------------------------
      - name: Compile Installer (.exe)
        shell: cmd
        run: |
          :: 1. 设置变量 (建议使用 set "VAR=Val" 格式防止尾部空格)
          ::    CMD 中引用变量使用 %VAR%
          set "OUTPUT_NAME=HashRenamer_Setup_v%BUILD_VERSION%"
          
          :: 2. 创建输出目录 (CMD 需先判断是否存在)
          if not exist Output mkdir Output
          
          :: 3. 执行 ISCC 编译
          ::    可以直接使用 /D, /O, /F，清晰且符合官方文档
          iscc "/DMyAppVersion=%BUILD_VERSION%" "/OOutput" "/F%OUTPUT_NAME%" installer.iss
          
          :: 4. 写入环境变量 (CMD 写法)
          ::    注意：>> 紧跟在值后面，不要加空格，否则变量值里会多出一个空格
          echo INSTALLER_NAME=%OUTPUT_NAME%>> %GITHUB_ENV%

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          # Artifact 名称也带上版本号
          name: HashRenamer_Installer_v${{ env.BUILD_VERSION }}
          path: Output/${{ env.INSTALLER_NAME }}.exe